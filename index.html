<!doctype html>
<html lang="fa" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Happy Coin: Crypto War — Optimized v2</title>
<style>
  :root{
    --bg1:#070709; --bg2:#121217; --accent:#00ffea; --danger:#ff004c; --purple:#7d00b2;
  }
  *{box-sizing:border-box;font-family:Tahoma, Arial, sans-serif}
  body{
    margin:0; min-height:100vh; background:linear-gradient(180deg,var(--bg1),var(--bg2));
    color:#e9eef0; display:flex; flex-direction:column; align-items:center; gap:12px; padding:18px;
  }
  header{width:100%; max-width:1100px; display:flex; justify-content:space-between; align-items:center; gap:8px}
  h1{color:var(--accent); font-size:1.4rem; margin:0}
  .top-stats{display:flex; gap:10px; align-items:center; font-size:0.95rem}
  .chip{background:#0e0e10;padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,0.03)}
  main{width:100%; max-width:1100px; display:flex; flex-direction:column; align-items:center; gap:12px}
  .card{width:100%; background:linear-gradient(180deg,#0b0b0d, #101012); border-radius:12px; padding:14px; box-shadow:0 6px 20px rgba(0,0,0,0.6); border:1px solid rgba(255,255,255,0.03)}
  .boss-visual{display:flex; flex-direction:column; align-items:center; gap:8px}
  .darknode { position:relative; width:220px; height:270px; border-radius:18px; background:linear-gradient(145deg,#141416,#0b0b0d); border:3px solid rgba(85,0,255,0.18); box-shadow:0 0 30px rgba(85,0,255,0.12) inset, 0 18px 40px rgba(0,0,0,0.6); overflow:hidden; }
  .aura{position:absolute; inset: -20px; background:radial-gradient(circle, rgba(125,0,178,0.16), transparent 35%); filter:blur(18px); z-index:0; animation:pulse 2.2s ease-in-out infinite alternate}
  @keyframes pulse{from{transform:scale(1);opacity:.7}to{transform:scale(1.09);opacity:1}}
  .circuit-lines{position:absolute; inset:0; background-image: linear-gradient(90deg, rgba(0,255,234,0.06) 1px, transparent 1px), linear-gradient(0deg, rgba(0,255,234,0.03) 1px, transparent 1px); background-size:8px 40px, 40px 8px; opacity:.8; mix-blend-mode:screen; transform:translateY(0); animation:glitch 1s infinite}
  @keyframes glitch{0%{transform:translate(0,0)}25%{transform:translate(-2px,1px)}50%{transform:translate(1px,-2px)}75%{transform:translate(-1px,2px)}100%{transform:translate(0,0)}}
  .eyes{position:absolute; top:38px; width:100%; display:flex; justify-content:space-between; padding:0 32px; z-index:2}
  .eye{width:26px; height:26px; background:radial-gradient(circle, #ff6b6b 0%, #ff1a1a 35%, #8f0000 70%); border-radius:50%; box-shadow:0 0 14px rgba(255,20,20,0.9), 0 0 26px rgba(255,80,80,0.15)}
  .core{position:absolute; left:50%; transform:translateX(-50%); bottom:48px; width:140px; height:80px; border-radius:8px; background:linear-gradient(180deg,#09090a,#111); border:2px solid rgba(0,255,234,0.04); box-shadow:0 0 18px rgba(125,0,178,0.06) inset}
  .name-tag{text-align:center;margin-top:4px;color:var(--accent); font-family:monospace; font-weight:700; text-shadow:0 0 8px rgba(0,255,234,0.1)}
  .hp-row{display:flex; gap:10px; align-items:center; width:100%}
  .bar-wrap{flex:1; background:#0b0b0d; padding:8px; border-radius:8px}
  .bar{height:18px; background:#222; border-radius:8px; overflow:hidden; border:1px solid rgba(255,255,255,0.02); position:relative;}
  .bar > i{display:block; height:100%; width:100%; transition:width .25s linear}
  .bar.boss > i{background:linear-gradient(90deg,var(--danger),var(--purple))}
  .bar.player > i{background:linear-gradient(90deg,#24d14f,#9be46b)}
  .hp-text{min-width:90px; text-align:center; font-size:0.9rem; position:relative;}
  .hp-text span{position:absolute; right:50%; transform:translateX(50%); font-size:0.75rem; color:#cfd8dc}
  .controls{display:flex; gap:10px; flex-wrap:wrap; justify-content:center}
  .btn{background:var(--accent); color:#001; border:none; padding:10px 14px; border-radius:8px; font-weight:700; cursor:pointer}
  .btn.secondary{background:#222; color:#eaeaea; border:1px solid rgba(255,255,255,0.03)}
  .btn.ghost{background:transparent; border:1px dashed rgba(255,255,255,0.04)}
  .log{background:#0b0b0d; width:100%; max-width:980px; padding:12px; border-radius:10px; font-size:0.9rem; max-height:240px; overflow:auto; border:1px solid rgba(255,255,255,0.02)}
  .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
  .stats-box{display:flex; gap:8px; align-items:center}
  .small{font-size:0.87rem; opacity:0.9}
  footer{margin-top:6px; opacity:.9; font-size:0.95rem; color:#cfd8dc; text-align:center; width:100%; max-width:1100px}
  .made-by{font-weight:700; color:#ffd59a; margin-top:6px}
  .modal{position:fixed; inset:0; background:rgba(0,0,0,0.6); display:none; align-items:center; justify-content:center; padding:18px; z-index:40}
  .modal.show{display:flex}
  .modal-card{width:100%; max-width:760px; background:linear-gradient(180deg,#0b0b0d,#0f0f11); padding:14px; border-radius:12px; border:1px solid rgba(255,255,255,0.03); position:relative}
  .stages{display:grid; grid-template-columns:repeat(auto-fit,minmax(140px,1fr)); gap:10px; max-height:60vh; overflow:auto; padding:8px}
  .stage{padding:12px; background:#0e0e10; border-radius:8px; text-align:center; cursor:pointer; border:1px solid rgba(255,255,255,0.02); user-select:none}
  .stage.locked{opacity:.45; filter:grayscale(20%); pointer-events:none;}
  .stage .num{font-weight:800; color:var(--accent); font-size:1.05rem}
  .stage .diff{font-size:0.82rem; margin-top:6px; color:#cfd8dc}
  @media (max-width:520px){
    .modal-card{width:95%}
    .stages{grid-template-columns:repeat(2,1fr)}
  }
  /* small responsive fixes */
  @media (max-width:420px){
    .hp-text{min-width:72px}
  }
</style>
</head>
<body>
<header>
  <h1>Happy Coin: Crypto War</h1>
  <div class="top-stats">
    <div class="chip">رمز ارز: <strong id="coins">0</strong> 🪙</div>
    <div class="chip">دیتاسنتر: <strong id="dcCount">0</strong></div>
    <div class="chip">قیمت بعدی DC: <strong id="dcCost">50</strong> 🪙</div>
  </div>
</header>

<main>
  <section class="card boss-visual">
    <div class="darknode" aria-hidden="true">
      <div class="aura"></div>
      <div class="circuit-lines"></div>
      <div class="eyes"><div class="eye"></div><div class="eye"></div></div>
      <div class="core"></div>
    </div>
    <div class="name-tag">DarkNode</div>

    <div style="width:100%;max-width:980px;margin-top:10px">
      <div class="hp-row">
        <div class="hp-text">باس <span id="bossPercent">100%</span></div>
        <div class="bar-wrap" aria-hidden="true">
          <div class="bar boss" role="progressbar" aria-valuemin="0" aria-valuemax="100"><i id="bossBar" style="width:100%"></i></div>
        </div>
        <div class="hp-text" id="bossHPText">HP: 300</div>
      </div>

      <div style="height:8px"></div>

      <div class="hp-row">
        <div class="hp-text">تو <span id="playerPercent">100%</span></div>
        <div class="bar-wrap" aria-hidden="true">
          <div class="bar player" role="progressbar" aria-valuemin="0" aria-valuemax="100"><i id="playerBar" style="width:100%"></i></div>
        </div>
        <div class="hp-text" id="playerHPText">HP: 100</div>
      </div>
    </div>

    <div class="controls" style="margin-top:12px">
      <button class="btn" id="openStagesBtn">حمله به DarkNode</button>
      <button class="btn secondary" id="buyDCBtn">خرید دیتاسنتر</button>
      <button class="btn ghost" id="retreatBtn" style="display:none">فرار</button>
    </div>

    <div style="margin-top:10px; font-size:0.9rem; color:#cfd8dc; text-align:center;">
      هر دیتاسنتر: <strong>+25 Max HP</strong> و افزایش دمیج
    </div>
  </section>

  <section class="card">
    <div class="row" style="justify-content:space-between;align-items:center">
      <div class="stats-box small">مرحله فعلی: <strong id="currentStageText">0</strong></div>
      <div class="stats-box small">وضعیت: <strong id="statusText">آماده</strong></div>
    </div>
    <div style="height:10px"></div>
    <div class="log" id="log" aria-live="polite">> خوش آمدی! برای شروع، روی «حمله به DarkNode» بزن.</div>
  </section>
</main>

<div id="stageModal" class="modal" aria-hidden="true">
  <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="stageTitle">
    <h3 id="stageTitle" style="margin:0 0 8px 0">انتخاب مرحله (۳۴ مرحله)</h3>
    <div class="stages" id="stagesGrid" tabindex="0" aria-label="لیست مراحل"></div>
    <div style="height:10px"></div>
    <div style="text-align:center"><button class="btn secondary" id="closeModalBtn">بستن</button></div>
  </div>
</div>

<footer>
  <div>نسخه آزمایشی — موبایل و دسکتاپ هماهنگ</div>
  <div class="made-by">ساخته شده توسط Rob Lucci</div>
</footer>

<script>
/* ===== Helpers ===== */
function readNumber(key,fallback){
  try{
    const v = localStorage.getItem(key);
    if (v === null) return fallback;
    const n = Number(v);
    return isNaN(n) ? fallback : n;
  }catch(e){
    return fallback;
  }
}
function safeLog(msg){
  // escape < & > to avoid injecting HTML
  const esc = String(msg).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  const logEl = document.getElementById('log');
  logEl.innerHTML = '> ' + esc + '<br>' + logEl.innerHTML;
}
function fmt(n){ return Math.round(n); }

/* ===== Game state ===== */
const TOTAL_STAGES = 34;
const BASE_PLAYER_MAX_HP = 100;
let coins = readNumber('hc_coins', 0);
let dcCount = readNumber('hc_dcCount', 0);
let dcCost = readNumber('hc_dcCost', 50);
let unlockedStage = readNumber('hc_unlocked', 1) || 1;

let playerMaxHP = BASE_PLAYER_MAX_HP + dcCount * 25;
let playerHP = playerMaxHP;
let bossMaxHP = 300;
let bossHP = bossMaxHP;
let bossAttackStrength = 8;
let bossAlive = false;
let currentStage = 0;
let bossAttackIntervalId = null;
let lastAttackType = null;

/* ===== DOM refs ===== */
const coinsEl = document.getElementById('coins');
const dcCountEl = document.getElementById('dcCount');
const dcCostEl = document.getElementById('dcCost');
const bossBarEl = document.getElementById('bossBar');
const playerBarEl = document.getElementById('playerBar');
const bossHPText = document.getElementById('bossHPText');
const playerHPText = document.getElementById('playerHPText');
const bossPercentEl = document.getElementById('bossPercent');
const playerPercentEl = document.getElementById('playerPercent');
const logEl = document.getElementById('log');
const openStagesBtn = document.getElementById('openStagesBtn');
const stageModal = document.getElementById('stageModal');
const stagesGrid = document.getElementById('stagesGrid');
const closeModalBtn = document.getElementById('closeModalBtn');
const buyDCBtn = document.getElementById('buyDCBtn');
const retreatBtn = document.getElementById('retreatBtn');
const currentStageText = document.getElementById('currentStageText');
const statusText = document.getElementById('statusText');

/* ===== Save / UI ===== */
function saveData(){
  try{
    localStorage.setItem('hc_coins', String(coins));
    localStorage.setItem('hc_dcCount', String(dcCount));
    localStorage.setItem('hc_dcCost', String(dcCost));
    localStorage.setItem('hc_unlocked', String(unlockedStage));
  }catch(e){
    console.warn('localStorage error', e);
  }
}

function recalcPlayerHPFromDC(){
  playerMaxHP = BASE_PLAYER_MAX_HP + dcCount * 25;
  if (playerHP > playerMaxHP) playerHP = playerMaxHP;
}

function updateUI(){
  recalcPlayerHPFromDC();
  coinsEl.innerText = fmt(coins);
  dcCountEl.innerText = dcCount;
  dcCostEl.innerText = fmt(dcCost);

  const bossPct = bossMaxHP ? Math.max(0, Math.round((bossHP / bossMaxHP) * 100)) : 0;
  const playerPct = playerMaxHP ? Math.max(0, Math.round((playerHP / playerMaxHP) * 100)) : 0;

  bossBarEl.style.width = bossPct + '%';
  playerBarEl.style.width = playerPct + '%';
  bossHPText.innerText = 'HP: ' + fmt(Math.max(0,bossHP)) + ' / ' + fmt(bossMaxHP);
  playerHPText.innerText = 'HP: ' + fmt(Math.max(0,playerHP)) + ' / ' + fmt(playerMaxHP);
  bossPercentEl.innerText = bossPct + '%';
  playerPercentEl.innerText = playerPct + '%';
  currentStageText.innerText = currentStage ? currentStage : '—';

  // accessibility: update aria value
  const bossBarParent = bossBarEl.parentElement;
  const playerBarParent = playerBarEl.parentElement;
  if (bossBarParent) bossBarParent.setAttribute('aria-valuenow', String(bossPct));
  if (playerBarParent) playerBarParent.setAttribute('aria-valuenow', String(playerPct));

  saveData();
}

/* ===== Formulas & balance ===== */
function computeBossHPForStage(stage){
  return Math.round(300 * Math.pow(1.5, stage-1));
}
function computeBossAttackForStage(stage){
  return Math.round(8 * Math.pow(1.22, stage-1));
}
// each DC now adds 35% damage (less oppressive than 60%)
function damageMultiplier(){ return 1 + dcCount * 0.35; }

/* ===== Stage grid builder ===== */
function buildStages(){
  stagesGrid.innerHTML = '';
  for (let s=1; s<=TOTAL_STAGES; s++){
    const div = document.createElement('div');
    div.className = 'stage' + (s > unlockedStage ? ' locked' : '');
    div.innerHTML = '<div class="num">مرحله ' + s + '</div><div class="diff">' + (s<=4?'آسان':s<=12?'متوسط':s<=24?'سخت':'نهایی') + '</div>';
    if (s <= unlockedStage){
      div.addEventListener('click', ()=> { startStage(s); closeStageModal(); });
      div.style.cursor = 'pointer';
    } else {
      // locked: no click, but add hint on hover for desktop (pointer-events none prevents clicking)
      div.title = 'این مرحله قفل است. مراحل قبلی را کامل کن یا دیتاسنتر بخر.';
    }
    stagesGrid.appendChild(div);
  }
}

/* ===== Modal controls ===== */
function openStageModal(){
  buildStages();
  stageModal.classList.add('show');
  stageModal.setAttribute('aria-hidden','false');
  // focus first unlocked stage for keyboard users
  setTimeout(()=>{ stagesGrid.focus(); }, 80);
}
function closeStageModal(){
  stageModal.classList.remove('show');
  stageModal.setAttribute('aria-hidden','true');
}

/* ===== Fight control UI (create/destroy) ===== */
function showFightControls(){
  if (document.getElementById('fightControls')) return;
  const cont = document.createElement('div');
  cont.id = 'fightControls';
  cont.style.position = 'fixed';
  cont.style.left = '50%';
  cont.style.transform = 'translateX(-50%)';
  cont.style.bottom = '14px';
  cont.style.zIndex = 50;
  cont.style.display = 'flex';
  cont.style.gap = '10px';
  cont.style.padding = '6px';
  cont.style.background = 'linear-gradient(180deg, rgba(10,10,12,0.9), rgba(8,8,10,0.85))';
  cont.style.borderRadius = '10px';
  cont.style.boxShadow = '0 6px 20px rgba(0,0,0,0.6)';
  cont.innerHTML = '<button class="btn" id="meleeBtnMobile">حمله تن به تن</button><button class="btn secondary" id="rangedBtnMobile">حمله کریپتو</button>';
  document.body.appendChild(cont);
  document.getElementById('meleeBtnMobile').addEventListener('click', ()=>playerAttack('melee'));
  document.getElementById('rangedBtnMobile').addEventListener('click', ()=>playerAttack('ranged'));
}
function hideFightControls(){ const e=document.getElementById('fightControls'); if(e) e.remove(); }

/* ===== Boss loop ===== */
function startBossLoop(stage){
  if (bossAttackIntervalId){ clearInterval(bossAttackIntervalId); bossAttackIntervalId = null; }
  const interval = Math.max(500, 1400 - (stage-1) * 30); // faster with higher stage
  bossAttackIntervalId = setInterval(()=>{
    if (!bossAlive) return;
    const base = computeBossAttackForStage(stage);
    const multiplier = (lastAttackType === 'melee') ? 1.45 : 1.0;
    const dmg = Math.max(1, Math.round(base * multiplier * (0.9 + Math.random()*0.35)));
    playerHP -= dmg;
    safeLog('DarkNode حمله کرد و ' + dmg + ' دمیج زد! (مرحله '+stage+')');
    if (playerHP <= 0){
      playerHP = 0;
      updateUI();
      endFight(false);
    } else {
      updateUI();
    }
  }, interval);
}

/* ===== Player actions ===== */
function playerAttack(type){
  if (!bossAlive){ safeLog('الان باس نیست، مرحله انتخاب کن.'); return; }
  lastAttackType = type;
  let base;
  if (type === 'melee'){
    base = Math.floor(Math.random()*18) + 12;
  } else {
    base = Math.floor(Math.random()*12) + 6;
  }
  const dmg = Math.round(base * damageMultiplier());
  bossHP -= dmg;
  const reward = Math.round(6 * Math.max(1,currentStage) * (type==='melee' ? 1 : 1.1)); // slightly lower per-hit reward
  coins += reward;
  safeLog('تو زدی ('+ (type==='melee'?'تن به تن':'کریپتو') +') و ' + dmg + ' دمیج وارد کردی — +' + reward + ' سکه');
  if (type === 'melee'){
    // small burst heal to boss (stagger mechanic) but limited
    const buff = Math.round(bossMaxHP * 0.01);
    bossHP = Math.min(bossHP + buff, bossMaxHP + buff);
    safeLog('حالت تن به تن! باس برای لحظه‌ای کمی قوی‌تر شد.');
  }
  updateUI();
  if (bossHP <= 0){
    bossHP = 0;
    updateUI();
    endFight(true);
  }
}

/* ===== End / Retreat ===== */
function endFight(victory){
  bossAlive = false;
  statusText.innerText = victory ? 'برنده شدی!' : 'شکست خوردی';
  if (bossAttackIntervalId){ clearInterval(bossAttackIntervalId); bossAttackIntervalId = null; }
  retreatBtn.style.display = 'none';
  hideFightControls();

  if (victory){
    // reward scales but less explosive
    const baseReward = Math.round(90 * Math.max(1,currentStage) * (1 + dcCount*0.08));
    coins += baseReward;
    recalcPlayerHPFromDC();
    playerHP = playerMaxHP;
    safeLog('تبریک! باس شکست خورد. دریافتی: +' + baseReward + ' سکه');
    safeLog('جان تو پس از پیروزی کامل بازیابی شد.');
    if (currentStage < TOTAL_STAGES && unlockedStage <= currentStage){
      unlockedStage = currentStage + 1;
      try{ localStorage.setItem('hc_unlocked', String(unlockedStage)); }catch(e){}
      safeLog('مرحله بعد باز شد: ' + unlockedStage);
    }
  } else {
    // loss should be fairer: 10 * stage, capped by coins
    const loss = Math.min(coins, Math.round(10 * Math.max(1,currentStage)));
    coins -= loss;
    safeLog('شکست خوردی... از دست دادی ' + loss + ' سکه');
    // small heal after defeat but not full
    recalcPlayerHPFromDC();
    playerHP = Math.max(1, Math.round(playerMaxHP * 0.35));
  }
  currentStage = 0;
  updateUI();
}

/* Retreat button */
retreatBtn.addEventListener('click', ()=>{
  if (!bossAlive) return;
  bossAlive = false;
  if (bossAttackIntervalId){ clearInterval(bossAttackIntervalId); bossAttackIntervalId = null; }
  safeLog('فرار کردی از مبارزه. سکه‌هاتو نگه دار!');
  statusText.innerText = 'آماده';
  retreatBtn.style.display = 'none';
  hideFightControls();
  currentStage = 0;
  updateUI();
});

/* ===== Buy Data Center ===== */
function buyDataCenter(){
  if (coins < dcCost){
    safeLog('رمز ارز کافی نداری برای خرید دیتاسنتر.');
    return;
  }
  coins -= dcCost;
  dcCount += 1;
  // gentler price growth
  dcCost = Math.min(999999999, Math.round(dcCost * 1.6));
  // recalc and heal a bit
  recalcPlayerHPFromDC();
  playerHP = playerMaxHP;
  safeLog('دیتاسنتر خریدی — +25 Max HP و قدرت دمیج افزایش پیدا کرد! (×' + damageMultiplier().toFixed(2) + ')');
  updateUI();
}

/* ===== Start Stage ===== */
function startStage(stage){
  if (bossAlive){ safeLog('الان در حال مبارزه‌ای — اول تمومش کن یا فرار کن.'); return; }
  currentStage = stage;
  bossMaxHP = computeBossHPForStage(stage);
  bossHP = bossMaxHP;
  bossAttackStrength = computeBossAttackForStage(stage);
  recalcPlayerHPFromDC();
  playerHP = playerMaxHP;
  bossAlive = true;
  statusText.innerText = 'در حال مبارزه (مرحله '+stage+')';
  safeLog('مرحله '+stage+' شروع شد! باس HP: '+bossMaxHP+' | حملهٔ باس: '+bossAttackStrength);
  retreatBtn.style.display = 'inline-block';
  showFightControls();
  startBossLoop(stage);
  updateUI();
}

/* ===== Keyboard shortcuts ===== */
document.addEventListener('keydown', (e)=>{
  if (!bossAlive) return;
  if (e.key === 'z' || e.key === 'Z') playerAttack('melee');
  if (e.key === 'x' || e.key === 'X') playerAttack('ranged');
});

/* ===== Desktop quick attack buttons (created once) ===== */
document.addEventListener('DOMContentLoaded', ()=>{
  const attackBar = document.createElement('div');
  attackBar.style.marginTop = '10px';
  attackBar.style.display = 'flex';
  attackBar.style.gap = '8px';
  attackBar.innerHTML = '<button class="btn" id="meleeBtn">حمله تن به تن (M)</button><button class="btn" id="rangedBtn">حمله کریپتو (X)</button>';
  document.querySelector('main').insertBefore(attackBar, document.querySelector('.card:last-of-type'));

  // desktop buttons behaviour: if no boss -> open stage modal; if boss -> attack
  document.getElementById('meleeBtn').addEventListener('click', ()=>{
    if(!bossAlive){ openStageModal(); } else playerAttack('melee');
  });
  document.getElementById('rangedBtn').addEventListener('click', ()=>{
    if(!bossAlive){ openStageModal(); } else playerAttack('ranged');
  });

  buildStages();
  updateUI();
});

/* ===== Modal buttons ===== */
openStagesBtn.addEventListener('click', openStageModal);
closeModalBtn.addEventListener('click', closeStageModal);

/* ===== Buy DC bind ===== */
buyDCBtn.addEventListener('click', buyDataCenter);

/* ===== Cleanup on unload ===== */
window.addEventListener('beforeunload', ()=>{
  if (bossAttackIntervalId) clearInterval(bossAttackIntervalId);
});

/* ===== Debug helper exposed for console (safe) ===== */
window.__hc = {
  buyDataCenter,
  playerAttack,
  startStage,
  computeBossHPForStage,
  computeBossAttackForStage,
  getState: ()=>({coins,dcCount,dcCost,unlockedStage,playerMaxHP,playerHP,bossHP,currentStage})
};

/* ===== Initial log entry ===== */
safeLog('بازی بارگذاری شد. موفق باشی، قهرمان!');

</script>
</body>
</html>