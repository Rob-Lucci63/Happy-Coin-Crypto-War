<!doctype html>
<html lang="fa" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Happy Coin: Crypto War â€” final</title>
<style>
  :root{
    --bg1:#070709; --bg2:#121217; --accent:#00ffea; --danger:#ff004c; --purple:#7d00b2;
  }
  *{box-sizing:border-box;font-family:Tahoma, Arial, sans-serif}
  body{
    margin:0; min-height:100vh; background:linear-gradient(180deg,var(--bg1),var(--bg2));
    color:#e9eef0; display:flex; flex-direction:column; align-items:center; gap:12px; padding:18px;
  }
  header{width:100%; max-width:1100px; display:flex; justify-content:space-between; align-items:center; gap:8px}
  h1{color:var(--accent); font-size:1.4rem; margin:0}
  .top-stats{display:flex; gap:10px; align-items:center; font-size:0.95rem}
  .chip{background:#0e0e10;padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,0.03)}
  main{width:100%; max-width:1100px; display:flex; flex-direction:column; align-items:center; gap:12px}
  .card{width:100%; background:linear-gradient(180deg,#0b0b0d, #101012); border-radius:12px; padding:14px; box-shadow:0 6px 20px rgba(0,0,0,0.6); border:1px solid rgba(255,255,255,0.03)}
  .boss-visual{display:flex; flex-direction:column; align-items:center; gap:8px}
  .darknode { position:relative; width:220px; height:270px; border-radius:18px; background:linear-gradient(145deg,#141416,#0b0b0d); border:3px solid rgba(85,0,255,0.18); box-shadow:0 0 30px rgba(85,0,255,0.12) inset, 0 18px 40px rgba(0,0,0,0.6); overflow:hidden; }
  .aura{position:absolute; inset: -20px; background:radial-gradient(circle, rgba(125,0,178,0.16), transparent 35%); filter:blur(18px); z-index:0; animation:pulse 2.2s ease-in-out infinite alternate}
  @keyframes pulse{from{transform:scale(1);opacity:.7}to{transform:scale(1.09);opacity:1}}
  .circuit-lines{position:absolute; inset:0; background-image: linear-gradient(90deg, rgba(0,255,234,0.06) 1px, transparent 1px), linear-gradient(0deg, rgba(0,255,234,0.03) 1px, transparent 1px); background-size:8px 40px, 40px 8px; opacity:.8; mix-blend-mode:screen; transform:translateY(0); animation:glitch 1s infinite}
  @keyframes glitch{0%{transform:translate(0,0)}25%{transform:translate(-2px,1px)}50%{transform:translate(1px,-2px)}75%{transform:translate(-1px,2px)}100%{transform:translate(0,0)}}
  .eyes{position:absolute; top:38px; width:100%; display:flex; justify-content:space-between; padding:0 32px; z-index:2}
  .eye{width:26px; height:26px; background:radial-gradient(circle, #ff6b6b 0%, #ff1a1a 35%, #8f0000 70%); border-radius:50%; box-shadow:0 0 14px rgba(255,20,20,0.9), 0 0 26px rgba(255,80,80,0.15)}
  .core{position:absolute; left:50%; transform:translateX(-50%); bottom:48px; width:140px; height:80px; border-radius:8px; background:linear-gradient(180deg,#09090a,#111); border:2px solid rgba(0,255,234,0.04); box-shadow:0 0 18px rgba(125,0,178,0.06) inset}
  .name-tag{text-align:center;margin-top:4px;color:var(--accent); font-family:monospace; font-weight:700; text-shadow:0 0 8px rgba(0,255,234,0.1)}
  .hp-row{display:flex; gap:10px; align-items:center; width:100%}
  .bar-wrap{flex:1; background:#0b0b0d; padding:8px; border-radius:8px}
  .bar{height:18px; background:#222; border-radius:8px; overflow:hidden; border:1px solid rgba(255,255,255,0.02)}
  .bar > i{display:block; height:100%; width:100%; transition:width .25s linear}
  .bar.boss > i{background:linear-gradient(90deg,var(--danger),var(--purple))}
  .bar.player > i{background:linear-gradient(90deg,#24d14f,#9be46b)}
  .hp-text{min-width:90px; text-align:center; font-size:0.9rem}
  .controls{display:flex; gap:10px; flex-wrap:wrap; justify-content:center}
  .btn{background:var(--accent); color:#001; border:none; padding:10px 14px; border-radius:8px; font-weight:700; cursor:pointer}
  .btn.secondary{background:#222; color:#eaeaea; border:1px solid rgba(255,255,255,0.03)}
  .btn.ghost{background:transparent; border:1px dashed rgba(255,255,255,0.04)}
  .log{background:#0b0b0d; width:100%; max-width:980px; padding:12px; border-radius:10px; font-size:0.9rem; max-height:240px; overflow:auto; border:1px solid rgba(255,255,255,0.02)}
  .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
  .stats-box{display:flex; gap:8px; align-items:center}
  .small{font-size:0.87rem; opacity:0.9}
  footer{margin-top:6px; opacity:.9; font-size:0.95rem; color:#cfd8dc; text-align:center; width:100%; max-width:1100px}
  .made-by{font-weight:700; color:#ffd59a; margin-top:6px}
  /* Modal / stages */
  .modal{position:fixed; inset:0; background:rgba(0,0,0,0.6); display:none; align-items:center; justify-content:center; padding:18px; z-index:40}
  .modal.show{display:flex}
  .modal-card{width:100%; max-width:760px; background:linear-gradient(180deg,#0b0b0d,#0f0f11); padding:14px; border-radius:12px; border:1px solid rgba(255,255,255,0.03); position:relative}
  .stages{display:grid; grid-template-columns:repeat(auto-fit,minmax(140px,1fr)); gap:10px; max-height:60vh; overflow:auto; padding:8px}
  .stage{padding:12px; background:#0e0e10; border-radius:8px; text-align:center; cursor:pointer; border:1px solid rgba(255,255,255,0.02)}
  .stage.locked{opacity:.45; filter:grayscale(20%)}
  .stage .num{font-weight:800; color:var(--accent); font-size:1.05rem}
  .stage .diff{font-size:0.82rem; margin-top:6px; color:#cfd8dc}
  @media (max-width:520px){
    .modal-card{width:95%}
    .stages{grid-template-columns:repeat(2,1fr)}
  }
</style>
</head>
<body>
<header>
  <h1>Happy Coin: Crypto War</h1>
  <div class="top-stats">
    <div class="chip">Ø±Ù…Ø² Ø§Ø±Ø²: <strong id="coins">0</strong> ğŸª™</div>
    <div class="chip">Ø¯ÛŒØªØ§Ø³Ù†ØªØ±: <strong id="dcCount">0</strong></div>
    <div class="chip">Ù‚ÛŒÙ…Øª Ø¨Ø¹Ø¯ÛŒ DC: <strong id="dcCost">50</strong> ğŸª™</div>
  </div>
</header>

<main>
  <section class="card boss-visual">
    <div class="darknode">
      <div class="aura"></div>
      <div class="circuit-lines"></div>
      <div class="eyes"><div class="eye"></div><div class="eye"></div></div>
      <div class="core"></div>
    </div>
    <div class="name-tag">DarkNode</div>

    <div style="width:100%;max-width:980px;margin-top:10px">
      <div class="hp-row">
        <div class="hp-text">Ø¨Ø§Ø³</div>
        <div class="bar-wrap">
          <div class="bar boss"><i id="bossBar" style="width:100%"></i></div>
        </div>
        <div class="hp-text" id="bossHPText">HP: 300</div>
      </div>

      <div style="height:8px"></div>

      <div class="hp-row">
        <div class="hp-text">ØªÙˆ</div>
        <div class="bar-wrap">
          <div class="bar player"><i id="playerBar" style="width:100%"></i></div>
        </div>
        <div class="hp-text" id="playerHPText">HP: 100</div>
      </div>
    </div>

    <div class="controls" style="margin-top:12px">
      <button class="btn" id="openStagesBtn">Ø­Ù…Ù„Ù‡ Ø¨Ù‡ DarkNode</button>
      <button class="btn secondary" id="buyDCBtn">Ø®Ø±ÛŒØ¯ Ø¯ÛŒØªØ§Ø³Ù†ØªØ±</button>
      <button class="btn ghost" id="retreatBtn" style="display:none">ÙØ±Ø§Ø±</button>
    </div>

    <div style="margin-top:10px; font-size:0.9rem; color:#cfd8dc; text-align:center;">
      Ù‡Ø± Ø¯ÛŒØªØ§Ø³Ù†ØªØ±: <strong>+25 Max HP</strong> Ùˆ Ø§ÙØ²Ø§ÛŒØ´ Ø¯Ù…ÛŒØ¬
    </div>
  </section>

  <section class="card">
    <div class="row" style="justify-content:space-between;align-items:center">
      <div class="stats-box small">Ù…Ø±Ø­Ù„Ù‡ ÙØ¹Ù„ÛŒ: <strong id="currentStageText">0</strong></div>
      <div class="stats-box small">ÙˆØ¶Ø¹ÛŒØª: <strong id="statusText">Ø¢Ù…Ø§Ø¯Ù‡</strong></div>
    </div>
    <div style="height:10px"></div>
    <div class="log" id="log">> Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒ! Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ØŒ Ø±ÙˆÛŒ Â«Ø­Ù…Ù„Ù‡ Ø¨Ù‡ DarkNodeÂ» Ø¨Ø²Ù†.</div>
  </section>
</main>

<!-- Stage modal -->
<div id="stageModal" class="modal" aria-hidden="true">
  <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="stageTitle">
    <h3 id="stageTitle" style="margin:0 0 8px 0">Ø§Ù†ØªØ®Ø§Ø¨ Ù…Ø±Ø­Ù„Ù‡ (Û³Û´ Ù…Ø±Ø­Ù„Ù‡)</h3>
    <div class="stages" id="stagesGrid" tabindex="0" aria-label="Ù„ÛŒØ³Øª Ù…Ø±Ø§Ø­Ù„"></div>
    <div style="height:10px"></div>
    <div style="text-align:center"><button class="btn secondary" id="closeModalBtn">Ø¨Ø³ØªÙ†</button></div>
  </div>
</div>

<footer>
  <div>Ù†Ø³Ø®Ù‡ Ø¢Ø²Ù…Ø§ÛŒØ´ÛŒ â€” Ù…ÙˆØ¨Ø§ÛŒÙ„ Ùˆ Ø¯Ø³Ú©ØªØ§Ù¾ Ù‡Ù…Ø§Ù‡Ù†Ú¯</div>
  <div class="made-by">Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯Ù‡ ØªÙˆØ³Ø· Rob Lucci</div>
</footer>

<script>
/* === SAFE localStorage read helper === */
function readNumber(key, fallback){
  try{
    const v = localStorage.getItem(key);
    if (v === null) return fallback;
    const n = Number(v);
    return isNaN(n) ? fallback : n;
  }catch(e){
    return fallback;
  }
}

/* === GAME STATE === */
const TOTAL_STAGES = 34;
const BASE_PLAYER_MAX_HP = 100;
let coins = readNumber('hc_coins', 0);
let dcCount = readNumber('hc_dcCount', 0);
let dcCost = readNumber('hc_dcCost', 50);
let unlockedStage = readNumber('hc_unlocked', 1);
if (!unlockedStage) unlockedStage = 1;

let playerMaxHP = BASE_PLAYER_MAX_HP + dcCount * 25;
let playerHP = playerMaxHP; // not saved between sessions
let bossMaxHP = 300;
let bossHP = bossMaxHP;
let bossAttackStrength = 8;
let bossAlive = false;
let currentStage = 0;
let bossAttackIntervalId = null;
let lastAttackType = null;

/* DOM refs */
const coinsEl = document.getElementById('coins');
const dcCountEl = document.getElementById('dcCount');
const dcCostEl = document.getElementById('dcCost');
const bossBarEl = document.getElementById('bossBar');
const playerBarEl = document.getElementById('playerBar');
const bossHPText = document.getElementById('bossHPText');
const playerHPText = document.getElementById('playerHPText');
const logEl = document.getElementById('log');
const openStagesBtn = document.getElementById('openStagesBtn');
const stageModal = document.getElementById('stageModal');
const stagesGrid = document.getElementById('stagesGrid');
const closeModalBtn = document.getElementById('closeModalBtn');
const buyDCBtn = document.getElementById('buyDCBtn');
const retreatBtn = document.getElementById('retreatBtn');
const currentStageText = document.getElementById('currentStageText');
const statusText = document.getElementById('statusText');

/* Utility */
function fmt(n){ return Math.round(n); }
function log(msg){ logEl.innerHTML = '> ' + msg + '<br>' + logEl.innerHTML; }

/* recalc player HP from DCs */
function recalcPlayerHPFromDC(){
  playerMaxHP = BASE_PLAYER_MAX_HP + dcCount * 25;
  if (playerHP > playerMaxHP) playerHP = playerMaxHP;
}

/* Save helper */
function saveData(){
  try{
    localStorage.setItem('hc_coins', String(coins));
    localStorage.setItem('hc_dcCount', String(dcCount));
    localStorage.setItem('hc_dcCost', String(dcCost));
    localStorage.setItem('hc_unlocked', String(unlockedStage));
  }catch(e){
    console.warn('localStorage error', e);
  }
}

/* UI updates + save (except playerHP) */
function updateUI(){
  recalcPlayerHPFromDC();
  coinsEl.innerText = fmt(coins);
  dcCountEl.innerText = dcCount;
  dcCostEl.innerText = fmt(dcCost);
  bossBarEl.style.width = (Math.max(0,bossHP)/bossMaxHP*100) + '%';
  playerBarEl.style.width = (Math.max(0,playerHP)/playerMaxHP*100) + '%';
  bossHPText.innerText = 'HP: ' + fmt(bossHP) + ' / ' + fmt(bossMaxHP);
  playerHPText.innerText = 'HP: ' + fmt(playerHP) + ' / ' + fmt(playerMaxHP);
  currentStageText.innerText = currentStage ? currentStage : 'â€”';
  saveData();
}

/* formulas */
function computeBossHPForStage(stage){
  return Math.round(300 * Math.pow(1.5, stage-1));
}
function computeBossAttackForStage(stage){
  return Math.round(8 * Math.pow(1.22, stage-1));
}
function damageMultiplier(){ return 1 + dcCount * 0.6; } // each DC adds +60% damage

/* Build stages (scrollable grid) */
function buildStages(){
  stagesGrid.innerHTML = '';
  for (let s=1; s<=TOTAL_STAGES; s++){
    const div = document.createElement('div');
    div.className = 'stage' + (s > unlockedStage ? ' locked' : '');
    div.innerHTML = '<div class="num">Ù…Ø±Ø­Ù„Ù‡ ' + s + '</div><div class="diff">' + (s<=4?'Ø¢Ø³Ø§Ù†':s<=12?'Ù…ØªÙˆØ³Ø·':s<=24?'Ø³Ø®Øª':'Ù†Ù‡Ø§ÛŒÛŒ') + '</div>';
    if (s <= unlockedStage){
      div.addEventListener('click', ()=> { startStage(s); closeStageModal(); });
      div.style.cursor = 'pointer';
    } else {
      div.addEventListener('click', ()=> { log('Ø§ÛŒÙ† Ù…Ø±Ø­Ù„Ù‡ Ù‚ÙÙ„ Ø§Ø³Øª. Ø¨Ø§ÛŒØ¯ Ù…Ø±Ø§Ø­Ù„ Ù‚Ø¨Ù„ÛŒ Ø±Ø§ ØªÙ…Ø§Ù… Ú©Ù†ÛŒ ÛŒØ§ Ø¯ÛŒØªØ§Ø³Ù†ØªØ± Ø¨Ø®Ø±ÛŒ.'); });
    }
    stagesGrid.appendChild(div);
  }
}

/* Modal controls (no refresh) */
function openStageModal(){
  buildStages();
  stageModal.classList.add('show');
  stageModal.setAttribute('aria-hidden','false');
  stagesGrid.focus();
}
function closeStageModal(){
  stageModal.classList.remove('show');
  stageModal.setAttribute('aria-hidden','true');
}

/* Start stage */
function startStage(stage){
  if (bossAlive){ log('Ø§Ù„Ø§Ù† Ø¯Ø± Ø­Ø§Ù„ Ù…Ø¨Ø§Ø±Ø²Ù‡â€ŒØ§ÛŒ â€” Ø§ÙˆÙ„ ØªÙ…ÙˆÙ…Ø´ Ú©Ù† ÛŒØ§ ÙØ±Ø§Ø± Ú©Ù†.'); return; }
  currentStage = stage;
  bossMaxHP = computeBossHPForStage(stage);
  bossHP = bossMaxHP;
  bossAttackStrength = computeBossAttackForStage(stage);
  recalcPlayerHPFromDC();
  playerHP = playerMaxHP;
  bossAlive = true;
  statusText.innerText = 'Ø¯Ø± Ø­Ø§Ù„ Ù…Ø¨Ø§Ø±Ø²Ù‡ (Ù…Ø±Ø­Ù„Ù‡ '+stage+')';
  log('Ù…Ø±Ø­Ù„Ù‡ '+stage+' Ø´Ø±ÙˆØ¹ Ø´Ø¯! Ø¨Ø§Ø³ HP: '+bossMaxHP+' | Ø­Ù…Ù„Ù‡Ù” Ø¨Ø§Ø³: '+bossAttackStrength);
  retreatBtn.style.display = 'inline-block';
  startBossLoop(stage);
  updateUI();
}

/* Boss attack loop */
function startBossLoop(stage){
  if (bossAttackIntervalId) { clearInterval(bossAttackIntervalId); bossAttackIntervalId = null; }
  const interval = Math.max(600, 1400 - (stage-1)*30);
  bossAttackIntervalId = setInterval(()=>{
    if (!bossAlive) return;
    const base = computeBossAttackForStage(stage);
    const multiplier = (lastAttackType === 'melee') ? 1.45 : 1.0;
    const dmg = Math.max(1, Math.round(base * multiplier * (0.9 + Math.random()*0.35)));
    playerHP -= dmg;
    log('DarkNode Ø­Ù…Ù„Ù‡ Ú©Ø±Ø¯ Ùˆ ' + dmg + ' Ø¯Ù…ÛŒØ¬ Ø²Ø¯! (Ù…Ø±Ø­Ù„Ù‡ '+stage+')');
    if (playerHP <= 0){
      playerHP = 0;
      updateUI();
      endFight(false);
    } else {
      updateUI();
    }
  }, interval);
}

/* Attack logic (exposed to buttons/keys) */
function playerAttack(type){
  if (!bossAlive){ log('Ø§Ù„Ø§Ù† Ø¨Ø§Ø³ Ù†ÛŒØ³ØªØŒ Ù…Ø±Ø­Ù„Ù‡ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†.'); return; }
  lastAttackType = type;
  let base;
  if (type === 'melee'){
    base = Math.floor(Math.random()*18) + 12;
  } else {
    base = Math.floor(Math.random()*12) + 6;
  }
  const dmg = Math.round(base * damageMultiplier());
  bossHP -= dmg;
  const reward = Math.round(8 * Math.max(1,currentStage) * (type==='melee' ? 1 : 1.1));
  coins += reward;
  log('ØªÙˆ Ø²Ø¯ÛŒ ('+ (type==='melee'?'ØªÙ† Ø¨Ù‡ ØªÙ†':'Ú©Ø±ÛŒÙ¾ØªÙˆ') +') Ùˆ ' + dmg + ' Ø¯Ù…ÛŒØ¬ ÙˆØ§Ø±Ø¯ Ú©Ø±Ø¯ÛŒ â€” +' + reward + ' Ø³Ú©Ù‡');
  if (type === 'melee'){
    const buff = Math.round(bossMaxHP * 0.02);
    bossHP = Math.min(bossHP + buff, bossMaxHP + buff);
    log('Ø­Ø§Ù„Øª ØªÙ† Ø¨Ù‡ ØªÙ†! Ø¨Ø§Ø³ Ø¨Ø±Ø§ÛŒ Ù„Ø­Ø¸Ù‡â€ŒØ§ÛŒ Ù‚ÙˆÛŒâ€ŒØªØ± Ø´Ø¯.');
  }
  updateUI();
  if (bossHP <= 0){
    bossHP = 0;
    updateUI();
    endFight(true);
  }
}

/* End fight */
function endFight(victory){
  bossAlive = false;
  statusText.innerText = victory ? 'Ø¨Ø±Ù†Ø¯Ù‡ Ø´Ø¯ÛŒ!' : 'Ø´Ú©Ø³Øª Ø®ÙˆØ±Ø¯ÛŒ';
  if (bossAttackIntervalId){ clearInterval(bossAttackIntervalId); bossAttackIntervalId = null; }
  retreatBtn.style.display = 'none';
  if (victory){
    const baseReward = Math.round(120 * Math.max(1,currentStage) * (1 + dcCount*0.1));
    coins += baseReward;
    recalcPlayerHPFromDC();
    playerHP = playerMaxHP;
    log('ØªØ¨Ø±ÛŒÚ©! Ø¨Ø§Ø³ Ø´Ú©Ø³Øª Ø®ÙˆØ±Ø¯. Ø¯Ø±ÛŒØ§ÙØªÛŒ: +' + baseReward + ' Ø³Ú©Ù‡');
    log('Ø¬Ø§Ù† ØªÙˆ Ù¾Ø³ Ø§Ø² Ù¾ÛŒØ±ÙˆØ²ÛŒ Ú©Ø§Ù…Ù„ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø´Ø¯.');
    if (currentStage < TOTAL_STAGES && unlockedStage <= currentStage){
      unlockedStage = currentStage + 1;
      try{ localStorage.setItem('hc_unlocked', String(unlockedStage)); }catch(e){}
      log('Ù…Ø±Ø­Ù„Ù‡ Ø¨Ø¹Ø¯ Ø¨Ø§Ø² Ø´Ø¯: ' + unlockedStage);
    }
  } else {
    const loss = Math.min(coins, Math.round(20 * Math.max(1,currentStage)));
    coins -= loss;
    log('Ø´Ú©Ø³Øª Ø®ÙˆØ±Ø¯ÛŒ... Ø§Ø² Ø¯Ø³Øª Ø¯Ø§Ø¯ÛŒ ' + loss + ' Ø³Ú©Ù‡');
  }
  currentStage = 0;
  updateUI();
}

/* Retreat */
retreatBtn.addEventListener('click', ()=>{
  if (!bossAlive) return;
  bossAlive = false;
  if (bossAttackIntervalId){ clearInterval(bossAttackIntervalId); bossAttackIntervalId = null; }
  log('ÙØ±Ø§Ø± Ú©Ø±Ø¯ÛŒ Ø§Ø² Ù…Ø¨Ø§Ø±Ø²Ù‡. Ø³Ú©Ù‡â€ŒÙ‡Ø§ØªÙˆ Ù†Ú¯Ù‡ Ø¯Ø§Ø±!');
  statusText.innerText = 'Ø¢Ù…Ø§Ø¯Ù‡';
  retreatBtn.style.display = 'none';
  currentStage = 0;
  updateUI();
});

/* === BUY DATA CENTER (NO LIMIT) === */
function buyDataCenter(){
  if (coins < dcCost){
    log('Ø±Ù…Ø² Ø§Ø±Ø² Ú©Ø§ÙÛŒ Ù†Ø¯Ø§Ø±ÛŒ Ø¨Ø±Ø§ÛŒ Ø®Ø±ÛŒØ¯ Ø¯ÛŒØªØ§Ø³Ù†ØªØ±.');
    return;
  }
  // no hard cap â€” user can buy unlimited DCs (limited only by coins)
  coins -= dcCost;
  dcCount += 1;
  // price growth
  dcCost = Math.round(dcCost * 1.8);
  // each DC adds +25 max HP and increases damage multiplier
  recalcPlayerHPFromDC();
  // heal player on buy
  playerHP = playerMaxHP;
  log('Ø¯ÛŒØªØ§Ø³Ù†ØªØ± Ø®Ø±ÛŒØ¯ÛŒ â€” +25 Max HP Ùˆ Ù‚Ø¯Ø±Øª Ø¯Ù…ÛŒØ¬ Ø§ÙØ²Ø§ÛŒØ´ Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯! (Ã—' + damageMultiplier().toFixed(2) + ')');
  updateUI();
}

/* Modal open/close events */
openStagesBtn.addEventListener('click', openStageModal);
closeModalBtn.addEventListener('click', closeStageModal);

/* Keyboard attacks */
document.addEventListener('keydown', (e)=>{
  if (!bossAlive) return;
  if (e.key === 'z' || e.key === 'Z') playerAttack('melee');
  if (e.key === 'x' || e.key === 'X') playerAttack('ranged');
});

/* Desktop quick attack buttons (insert after DOM ready) */
document.addEventListener('DOMContentLoaded', ()=>{
  const attackBar = document.createElement('div');
  attackBar.style.marginTop = '10px';
  attackBar.style.display = 'flex';
  attackBar.style.gap = '8px';
  attackBar.innerHTML = '<button class="btn" id="meleeBtn">Ø­Ù…Ù„Ù‡ ØªÙ† Ø¨Ù‡ ØªÙ† (Melee)</button><button class="btn" id="rangedBtn">Ø­Ù…Ù„Ù‡ Ú©Ø±ÛŒÙ¾ØªÙˆ (Ranged)</button>';
  document.querySelector('main').insertBefore(attackBar, document.querySelector('.card:last-of-type'));
  document.getElementById('meleeBtn').addEventListener('click', ()=>{ if(!bossAlive){ openStageModal(); } else playerAttack('melee'); });
  document.getElementById('rangedBtn').addEventListener('click', ()=>{ if(!bossAlive){ openStageModal(); } else playerAttack('ranged'); });

  buildStages();
  updateUI();
});

/* show/hide mobile fight controls based on bossAlive */
setInterval(()=>{ if (bossAlive) showFightControls(); else hideFightControls(); }, 500);

function showFightControls(){
  if (document.getElementById('fightControls')) return;
  const cont = document.createElement('div');
  cont.id = 'fightControls';
  cont.style.position = 'fixed';
  cont.style.left = '50%';
  cont.style.transform = 'translateX(-50%)';
  cont.style.bottom = '14px';
  cont.style.zIndex = 50;
  cont.style.display = 'flex';
  cont.style.gap = '10px';
  cont.innerHTML = '<button class="btn" id="meleeBtnMobile">Ø­Ù…Ù„Ù‡ ØªÙ† Ø¨Ù‡ ØªÙ†</button><button class="btn secondary" id="rangedBtnMobile">Ø­Ù…Ù„Ù‡ Ú©Ø±ÛŒÙ¾ØªÙˆ</button>';
  document.body.appendChild(cont);
  document.getElementById('meleeBtnMobile').addEventListener('click', ()=>playerAttack('melee'));
  document.getElementById('rangedBtnMobile').addEventListener('click', ()=>playerAttack('ranged'));
}
function hideFightControls(){ const e=document.getElementById('fightControls'); if(e) e.remove(); }

/* cleanup */
window.addEventListener('beforeunload', ()=>{ if (bossAttackIntervalId) clearInterval(bossAttackIntervalId); });

/* Debug */
window.__hc = { buyDataCenter, playerAttack, startStage, computeBossHPForStage, computeBossAttackForStage, getState:()=>({coins,dcCount,dcCost,unlockedStage,playerMaxHP}) };
</script>
</body>
</html>